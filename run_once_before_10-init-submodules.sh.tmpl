#!/usr/bin/env bash

# This script hydrates the .external_sources cache so that
# the ML4W setup scripts (Step 30) have access to the upstream repo.

# We use the same path structure as config.py in the merge tool
EXTERNAL_DIR="{{ .chezmoi.sourceDir }}/.external_sources"
ML4W_REPO_DIR="$EXTERNAL_DIR/dotfiles"
ML4W_URL="https://github.com/mylinuxforwork/dotfiles.git"

echo ":: EXTERNAL SOURCES HOOK ::"

# Check if the repo exists. If not, clone it.
if [ ! -d "$ML4W_REPO_DIR/.git" ]; then
    echo ":: ML4W cache missing. Cloning from upstream..."
    
    # Ensure parent dir exists
    mkdir -p "$EXTERNAL_DIR"
    
    # Clone freshly (matches logic of merge-assistant.py when cache is missing)
    git clone "$ML4W_URL" "$ML4W_REPO_DIR"
    
    echo ":: Clone complete."
else
    echo ":: ML4W cache found. Skipping clone."
fi
