#!/usr/bin/env bash

# {{ if eq .chezmoi.hostname "ml-server" }}

# setup-openrgb.sh
# Configures OpenRGB, Kernel Modules, Permissions, and Bootloader arguments.
# intended for hostname: ml-server

set -euo pipefail

# ---------- logging
info() { printf "\033[1;32m[INFO]\033[0m %s\n" "$*"; }
warn() { printf "\033[1;33m[WARN]\033[0m %s\n" "$*"; }
err()  { printf "\033[1;31m[ERR ]\033[0m %s\n" "$*" >&2; }

# ---------- main logic
info "Starting OpenRGB Setup..."

# 1. Install packages
if ! pacman -Qi openrgb >/dev/null 2>&1; then
    info "Installing OpenRGB and i2c-tools..."
    sudo pacman -S --needed --noconfirm openrgb
fi

if ! pacman -Qi i2c-tools >/dev/null 2>&1; then
    info "Installing OpenRGB and i2c-tools..."
    sudo pacman -S --needed --noconfirm i2c-tools
fi

# 2. Configure Kernel Modules
# i2c-dev is required for userspace access
if [ ! -f /etc/modules-load.d/i2c-dev.conf ]; then
    echo "i2c-dev" | sudo tee /etc/modules-load.d/i2c-dev.conf >/dev/null
    info "Enabled i2c-dev module."
fi

# i2c-piix4 for AMD SMBus
if [ ! -f /etc/modules-load.d/i2c-piix4.conf ]; then
    echo "i2c-piix4" | sudo tee /etc/modules-load.d/i2c-piix4.conf >/dev/null
    info "Enabled i2c-piix4 module."
fi

# Load modules immediately
if ! lsmod | grep -q i2c_dev; then
    sudo modprobe i2c-dev
    info "Loaded i2c-dev module immediately."
fi
if ! lsmod | grep -q i2c_piix4; then
    sudo modprobe i2c-piix4
    info "Loaded i2c-piix4 module immediately."
fi

# 3. Setup Udev rules for 'i2c' group access
if [ ! -f /etc/udev/rules.d/99-i2c.rules ]; then
    echo 'KERNEL=="i2c-[0-9]*", GROUP="i2c", MODE="0660"' | sudo tee /etc/udev/rules.d/99-i2c.rules >/dev/null
    sudo udevadm control --reload && sudo udevadm trigger
    info "Created udev rules for i2c access."
fi

# 4. Add User to i2c group
getent group i2c >/dev/null || sudo groupadd i2c
if ! groups "$USER" | grep -q '\bi2c\b'; then
    sudo usermod -aG i2c "$USER"
    info "Added $USER to i2c group. (Log out required to take effect)."
fi

# 5. Patch Limine Kernel Arguments (The Safe Way)
LIMINE_DEFAULT="/etc/default/limine"
TARGET_PARAM="acpi_enforce_resources=lax"

if [ -f "$LIMINE_DEFAULT" ]; then
    # Only run if the param is missing from the config
    if ! grep -q "$TARGET_PARAM" "$LIMINE_DEFAULT"; then
        info "Patching Limine for SMBus access..."

        # 1. Get current running args (The Source of Truth)
        # We strip out BOOT_IMAGE and initrd because Limine handles those automatically
        CURRENT_ARGS=$(sed 's/BOOT_IMAGE=[^ ]* //g; s/initrd=[^ ]* //g' /proc/cmdline)
        
        # 2. Construct the NEW full command line
        # This ensures we keep 'root=UUID...' and just add our param to the end
        NEW_CMDLINE="$CURRENT_ARGS $TARGET_PARAM"
        
        # 3. Write the FULL line to the config using '=' assignment (not +=)
        # This prevents the generator from getting confused or dropping the defaults
        echo "KERNEL_CMDLINE[default]=\"$NEW_CMDLINE\"" | sudo tee -a "$LIMINE_DEFAULT" >/dev/null
        
        info "Updated $LIMINE_DEFAULT with full argument list."
        info "Regenerating Limine config..."
        
        if command -v limine-mkinitcpio >/dev/null; then
            sudo limine-mkinitcpio
        elif command -v limine-update >/dev/null; then
            sudo limine-update
        else
            warn "Could not find limine-mkinitcpio or limine-update. Please regenerate manually."
        fi
        
    else
        info "Limine config already patched."
    fi
else
    warn "$LIMINE_DEFAULT not found. Skipping bootloader patch."
fi

info "OpenRGB setup complete."

# {{ end }}