#!/bin/bash
set -euo pipefail

HOSTNAME="{{ .chezmoi.hostname }}"
DEST="/usr/lib/firmware/edid/edid.bin"
LIMINE_DEFAULT="/etc/default/limine"

# --- HOST CONFIGURATION ---
{{ if eq .chezmoi.hostname "arch-lenovo" -}}
SRC="{{ .chezmoi.sourceDir }}/files/edid/edid-arch-lenovo.bin"
TARGET_PARAMS="nvidia_drm.modeset=1 drm.edid_firmware=DP-2:edid/edid.bin"
# hash: {{ include "files/edid/edid-arch-lenovo.bin" | sha256sum }}
{{ else if eq .chezmoi.hostname "ml-server" -}}
SRC="{{ .chezmoi.sourceDir }}/files/edid/edid-ml-server.bin"
TARGET_PARAMS="nvidia_drm.modeset=1 drm.edid_firmware=HDMI-A-2:edid/edid.bin"
# hash: {{ include "files/edid/edid-ml-server.bin" | sha256sum }}
{{ else -}}
echo "Host $HOSTNAME not configured for EDID override."
exit 0
{{ end -}}

# --- INSTALL EDID BINARY ---
echo "Installing EDID for $HOSTNAME..."
sudo mkdir -p "$(dirname "$DEST")"
sudo cp "$SRC" "$DEST"

# --- CONFIGURE MKINITCPIO ---
if ! grep -q "/usr/lib/firmware/edid/edid.bin" /etc/mkinitcpio.conf; then
    sudo sed -i 's|FILES=(|FILES=(/usr/lib/firmware/edid/edid.bin |' /etc/mkinitcpio.conf
fi

# --- PATCH LIMINE ---
if [ -f "$LIMINE_DEFAULT" ]; then
    # Use a more generic grep to see if ANY firmware override is already there
    if ! grep -q "drm.edid_firmware=" "$LIMINE_DEFAULT"; then
        echo "âš¡ Patching Limine for $HOSTNAME..."
        CURRENT_ARGS=$(sed 's/BOOT_IMAGE=[^ ]* //g; s/initrd=[^ ]* //g; s/nvidia_drm.modeset=[^ ]* //g; s/drm.edid_firmware=[^ ]* //g' /proc/cmdline)
        echo "KERNEL_CMDLINE[default]=\"$CURRENT_ARGS $TARGET_PARAMS\"" | sudo tee -a "$LIMINE_DEFAULT" >/dev/null
        
        # Regenerate
        if command -v limine-mkinitcpio >/dev/null; then
            sudo limine-mkinitcpio
        else
            sudo mkinitcpio -P
            sudo limine-update
        fi
    fi
fi