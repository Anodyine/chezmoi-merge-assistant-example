#!/bin/bash
set -euo pipefail

HOSTNAME="{{ .chezmoi.hostname }}"
FW_DIR="/usr/lib/firmware/edid"
LIMINE_DEFAULT="/etc/default/limine"

# --- HOST CONFIGURATION ---
{{ if eq .chezmoi.hostname "arch-lenovo" -}}
EDID_FILES=("files/edid/edid-1920-1440-56:edid.bin")
# Single monitor syntax
TARGET_PARAMS="nvidia_drm.modeset=1 drm.edid_firmware=DP-2:edid/edid.bin"
# hash: {{ include "files/edid/edid-1920-1440-56" | sha256sum }}

{{ else if eq .chezmoi.hostname "ml-server" -}}
EDID_FILES=(
    "files/edid/edid-1920-1440-56:edid-1440.bin"
    "files/edid/edid-1920-1280-60:edid-1280.bin"
)
# Multi-monitor syntax: comma-separated list under one parameter
TARGET_PARAMS="nvidia_drm.modeset=1 drm.edid_firmware=HDMI-A-1:edid/edid-1440.bin,HDMI-A-2:edid/edid-1280.bin"
# hash: {{ include "files/edid/edid-1920-1440-56" | sha256sum }}
# hash: {{ include "files/edid/edid-1920-1280-60" | sha256sum }}

{{ else -}}
echo "Host $HOSTNAME not configured for EDID override."
exit 0
{{ end -}}

# --- INSTALL EDID BINARIES ---
sudo mkdir -p "$FW_DIR"

for entry in "${EDID_FILES[@]}"; do
    SRC_REL="${entry%%:*}"
    DEST_NAME="${entry##*:}"
    FULL_SRC="{{ .chezmoi.sourceDir }}/$SRC_REL"
    FULL_DEST="$FW_DIR/$DEST_NAME"

    echo "Installing $DEST_NAME for $HOSTNAME..."
    sudo cp "$FULL_SRC" "$FULL_DEST"

    # Ensure each firmware file is in mkinitcpio.conf
    if ! grep -q "$FULL_DEST" /etc/mkinitcpio.conf; then
        sudo sed -i "s|FILES=(|FILES=($FULL_DEST |" /etc/mkinitcpio.conf
    fi
done

# --- PATCH LIMINE ---
if [ -f "$LIMINE_DEFAULT" ]; then
    # Clean baseline: strip out any previous attempts or duplicates
    BASE_ARGS=$(sed 's/BOOT_IMAGE=[^ ]* //g; s/initrd=[^ ]* //g; s/nvidia_drm.modeset=[^ ]* //g; s/drm.edid_firmware=[^ ]* //g' /proc/cmdline)
    NEW_LINE="KERNEL_CMDLINE[default]=\"$BASE_ARGS $TARGET_PARAMS\""

    # Only apply if the config doesn't already match our target exactly
    if ! grep -qF "$NEW_LINE" "$LIMINE_DEFAULT"; then
        echo "âš¡ Updating Limine configuration with comma-separated EDIDs..."
        
        # Remove all existing KERNEL_CMDLINE[default] entries
        sudo sed -i '/^KERNEL_CMDLINE\[default\]=/d' "$LIMINE_DEFAULT"
        
        # Append the corrected single line
        echo "$NEW_LINE" | sudo tee -a "$LIMINE_DEFAULT" >/dev/null

        # Trigger rebuild
        if command -v limine-mkinitcpio >/dev/null; then
            sudo limine-mkinitcpio
        else
            sudo mkinitcpio -P
            sudo limine-update
        fi
    fi
fi