#!/bin/bash

# Title: Fully Automated Limine & Snapper Setup
# Description: Installs Yay, configures Limine (Custom Path), adds overlayfs, and enables sync.

set -e

# --- 1. Helper Detection & Auto-Install ---
if command -v paru &> /dev/null; then
    AUR_HELPER="paru"
    echo "Detected existing AUR helper: $AUR_HELPER"
elif command -v yay &> /dev/null; then
    AUR_HELPER="yay"
    echo "Detected existing AUR helper: $AUR_HELPER"
else
    echo "No AUR helper found. Installing yay..."
    sudo pacman -S --needed --noconfirm git base-devel
    
    TEMP_DIR=$(mktemp -d)
    git clone https://aur.archlinux.org/yay-bin.git "$TEMP_DIR/yay-bin"
    
    pushd "$TEMP_DIR/yay-bin" > /dev/null
    makepkg -si --noconfirm
    popd > /dev/null
    
    rm -rf "$TEMP_DIR"
    AUR_HELPER="yay"
    echo "Successfully installed yay."
fi

# --- 2. Install System Dependencies ---
echo "Installing limine-snapper-sync, snap-pac, and mkinitcpio-btrfs-overlayfs..."
$AUR_HELPER -S --needed --noconfirm limine-snapper-sync snap-pac mkinitcpio-btrfs-overlayfs

# --- 3. Configure Limine (Targeting YOUR specific path) ---
LIMINE_CONF="/boot/EFI/arch-limine/limine.conf"

if [ -f "$LIMINE_CONF" ]; then
    if grep -q "//Snapshots" "$LIMINE_CONF"; then
        echo "Limine config already contains //Snapshots directive. Skipping."
    else
        echo "Backing up limine.conf..."
        sudo cp "$LIMINE_CONF" "$LIMINE_CONF.bak"
        echo "Injecting //Snapshots directive into limine.conf..."
        echo -e "\n//Snapshots" | sudo tee -a "$LIMINE_CONF" > /dev/null
    fi
else
    echo "Error: $LIMINE_CONF not found. Please verify the path."
    exit 1
fi

# --- 3.5 Configure the Sync Tool (CRITICAL STEP) ---
# We must tell limine-snapper-sync to use your custom path, 
# otherwise it defaults to /boot/limine.conf and your menu won't update.
SYNC_DEFAULTS="/etc/default/limine-snapper-sync"

echo "Configuring limine-snapper-sync to use $LIMINE_CONF..."
# Create the defaults file if it doesn't exist, or edit it if it does
if [ -f "$SYNC_DEFAULTS" ]; then
    # Replace existing config line or append if missing
    if grep -q "LIMINE_CONFIG=" "$SYNC_DEFAULTS"; then
        sudo sed -i "s|.*LIMINE_CONFIG=.*|LIMINE_CONFIG=\"$LIMINE_CONF\"|" "$SYNC_DEFAULTS"
    else
        echo "LIMINE_CONFIG=\"$LIMINE_CONF\"" | sudo tee -a "$SYNC_DEFAULTS" > /dev/null
    fi
else
    # Create file with the variable
    echo "LIMINE_CONFIG=\"$LIMINE_CONF\"" | sudo tee "$SYNC_DEFAULTS" > /dev/null
fi

# --- 4. Configure mkinitcpio (OverlayFS Hook) ---
MKINIT_CONF="/etc/mkinitcpio.conf"
HOOK_NAME="btrfs-overlayfs"

if grep -q "$HOOK_NAME" "$MKINIT_CONF"; then
    echo "Hook '$HOOK_NAME' already present in $MKINIT_CONF. Skipping edit."
else
    echo "Backing up mkinitcpio.conf..."
    sudo cp "$MKINIT_CONF" "$MKINIT_CONF.bak"
    echo "Injecting '$HOOK_NAME' into HOOKS..."
    sudo sed -i "s/filesystems/filesystems $HOOK_NAME/" "$MKINIT_CONF"
fi

# --- 5. Regenerate Initramfs ---
echo "Regenerating initramfs..."
sudo mkinitcpio -P

# --- 6. Enable Services & Sync ---
echo "Enabling limine-snapper-sync watcher..."
sudo systemctl enable --now limine-snapper-sync.service

echo "Running initial snapshot sync..."
sudo limine-snapper-sync

echo "----------------------------------------------------------------"
echo "SUCCESS: Bootable snapshots are configured for:"
echo " $LIMINE_CONF"
echo "----------------------------------------------------------------"