#!/bin/bash

# Title: Fully Automated Limine & Snapper Setup (with Yay Auto-Install)
# Description: Installs Yay (if missing), dependencies, configures Limine, adds overlayfs hook, and regenerates initramfs.

set -e

# --- 1. Helper Detection & Auto-Install ---
if command -v paru &> /dev/null; then
    AUR_HELPER="paru"
    echo "Detected existing AUR helper: $AUR_HELPER"
elif command -v yay &> /dev/null; then
    AUR_HELPER="yay"
    echo "Detected existing AUR helper: $AUR_HELPER"
else
    echo "No AUR helper found. Installing yay..."
    
    # Install prerequisites
    sudo pacman -S --needed --noconfirm git base-devel
    
    # Clone and install yay-bin (faster than compiling from source)
    # We use a temporary directory to keep things clean
    TEMP_DIR=$(mktemp -d)
    git clone https://aur.archlinux.org/yay-bin.git "$TEMP_DIR/yay-bin"
    
    pushd "$TEMP_DIR/yay-bin" > /dev/null
    makepkg -si --noconfirm
    popd > /dev/null
    
    # Cleanup
    rm -rf "$TEMP_DIR"
    
    AUR_HELPER="yay"
    echo "Successfully installed yay."
fi

# --- 2. Install System Dependencies ---
echo "Installing limine-snapper-sync, snap-pac, and mkinitcpio-btrfs-overlayfs..."
$AUR_HELPER -S --needed --noconfirm limine-snapper-sync snap-pac mkinitcpio-btrfs-overlayfs

# --- 3. Configure Limine ---
LIMINE_CONF="/boot/EFI/arch-limine/limine.conf"
if [ -f "$LIMINE_CONF" ]; then
    if grep -q "//Snapshots" "$LIMINE_CONF"; then
        echo "Limine config already contains //Snapshots directive. Skipping."
    else
        echo "Backing up limine.conf..."
        sudo cp "$LIMINE_CONF" "$LIMINE_CONF.bak"
        echo "Injecting //Snapshots directive into limine.conf..."
        echo -e "\n//Snapshots" | sudo tee -a "$LIMINE_CONF" > /dev/null
    fi
else
    echo "Error: $LIMINE_CONF not found. Is /boot mounted?"
    exit 1
fi

# --- 4. Configure mkinitcpio (OverlayFS Hook) ---
MKINIT_CONF="/etc/mkinitcpio.conf"
HOOK_NAME="btrfs-overlayfs"

if grep -q "$HOOK_NAME" "$MKINIT_CONF"; then
    echo "Hook '$HOOK_NAME' already present in $MKINIT_CONF. Skipping edit."
else
    echo "Backing up mkinitcpio.conf..."
    sudo cp "$MKINIT_CONF" "$MKINIT_CONF.bak"
    
    echo "Injecting '$HOOK_NAME' into HOOKS..."
    # Uses sed to append 'btrfs-overlayfs' immediately after 'filesystems'
    sudo sed -i "s/filesystems/filesystems $HOOK_NAME/" "$MKINIT_CONF"
    
    # Verify the edit worked
    if grep -q "$HOOK_NAME" "$MKINIT_CONF"; then
        echo "Successfully added hook."
    else
        echo "Error: Failed to inject hook automatically. Please check $MKINIT_CONF manually."
        exit 1
    fi
fi

# --- 5. Regenerate Initramfs ---
echo "Regenerating initramfs (this may take a moment)..."
sudo mkinitcpio -P

# --- 6. Enable Services & Sync ---
echo "Enabling limine-snapper-sync watcher..."
sudo systemctl enable --now limine-snapper-sync.service

echo "Running initial snapshot sync..."
sudo limine-snapper-sync

echo "----------------------------------------------------------------"
echo "SUCCESS: Bootable snapshots are configured."
echo "You can now reboot and see your snapshots in the Limine menu."
echo "----------------------------------------------------------------"