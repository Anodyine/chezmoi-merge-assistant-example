#!/bin/bash

# Title: Automated Limine & Snapper Setup (Silent & Fixed)
# Description: Installs hooks, configures Limine/Snapper, and regenerates images non-interactively.

set -e

# --- 1. Helper Detection & Auto-Install ---
if command -v paru &> /dev/null; then
    AUR_HELPER="paru"
elif command -v yay &> /dev/null; then
    AUR_HELPER="yay"
else
    echo "Installing yay..."
    sudo pacman -S --needed --noconfirm git base-devel
    TEMP_DIR=$(mktemp -d)
    git clone https://aur.archlinux.org/yay-bin.git "$TEMP_DIR/yay-bin"
    (cd "$TEMP_DIR/yay-bin" && makepkg -si --noconfirm)
    rm -rf "$TEMP_DIR"
    AUR_HELPER="yay"
fi

# --- 2. Install Packages (Silent) ---
# Added --answerclean and --answerdiff to suppress the "Diffs to show?" prompts
echo "Installing dependencies..."
$AUR_HELPER -S --needed --noconfirm --answerclean None --answerdiff None \
    limine-snapper-sync snap-pac limine-mkinitcpio-hook

# --- 3. Configure Limine ---
LIMINE_CONF="/boot/EFI/arch-limine/limine.conf"

if [ -f "$LIMINE_CONF" ]; then
    if grep -q "//Snapshots" "$LIMINE_CONF"; then
        echo "Limine config already contains //Snapshots. Skipping."
    else
        echo "Injecting //Snapshots directive..."
        echo -e "\n//Snapshots" | sudo tee -a "$LIMINE_CONF" > /dev/null
    fi
else
    echo "Error: $LIMINE_CONF not found."
    exit 1
fi

# --- 4. Central Configuration ---
DEFAULT_CONF="/etc/default/limine"
echo "Configuring global defaults..."
sudo touch "$DEFAULT_CONF"

# Set the Limine Config path so tools know where to write
if grep -q "LIMINE_CONFIG=" "$DEFAULT_CONF"; then
    sudo sed -i "s|.*LIMINE_CONFIG=.*|LIMINE_CONFIG=\"$LIMINE_CONF\"|" "$DEFAULT_CONF"
else
    echo "LIMINE_CONFIG=\"$LIMINE_CONF\"" | sudo tee -a "$DEFAULT_CONF" > /dev/null
fi

# --- 5. Enable Overlay Hook ---
MKINIT_CONF="/etc/mkinitcpio.conf"
HOOK_NAME="btrfs-overlayfs"

if grep -q "$HOOK_NAME" "$MKINIT_CONF"; then
    echo "Hook '$HOOK_NAME' already active."
else
    echo "Adding '$HOOK_NAME' to mkinitcpio.conf..."
    # Insert 'btrfs-overlayfs' immediately after 'filesystems'
    sudo sed -i "s/filesystems/filesystems $HOOK_NAME/" "$MKINIT_CONF"
fi

# --- 6. Finalize (The Fix) ---
# We use 'limine-mkinitcpio' instead of 'mkinitcpio -P'.
# This command is aware of Limine, regenerates the images with the new hook,
# and updates the boot entries without triggering the interactive warning.
echo "Regenerating initramfs and updating Limine..."
sudo limine-mkinitcpio

echo "Enabling automation..."
sudo systemctl enable --now limine-snapper-sync.service
# Run one sync to populate the menu immediately
sudo limine-snapper-sync

echo "SUCCESS: Snapshot booting configured non-interactively."