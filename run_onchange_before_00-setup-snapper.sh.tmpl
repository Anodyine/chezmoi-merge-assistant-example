#!/bin/bash
set -e
# ---------------------------------------------------------------------------------
# Snapper & Limine Setup via Chezmoi
# ---------------------------------------------------------------------------------

# packages_hash: {{ "snapper snap-pac inotify-tools git base-devel" | sha256sum }}

echo ">> [Chezmoi] Starting Snapper & Limine Sync Setup..."

# 1. Configure Snapper
echo ">> [Chezmoi] Configuring Snapper root layout..."
if [ ! -f "/etc/snapper/configs/root" ]; then
    echo "   Config missing. preparing layout..."
    # Unmount /.snapshots if it exists to allow fresh init
    if mountpoint -q /.snapshots; then sudo umount /.snapshots; fi
    if [ -d "/.snapshots" ]; then sudo rm -rf /.snapshots; fi

    sudo snapper -c root create-config /
    
    # Re-establish the mount point
    sudo rm -rf /.snapshots
    sudo mkdir -p /.snapshots
    sudo mount -a
else
    echo "   Snapper config already exists. Skipping init."
fi

# 2. Configure Retention & Permissions
echo ">> [Chezmoi] Applying retention policy..."
CONF="/etc/snapper/configs/root"
USER="{{ .chezmoi.username }}" 

echo "   Setting permissions for user: $USER"
sudo chmod a+rx /.snapshots
sudo chown :$USER /.snapshots

# Standard retention policy
sudo sed -i "s/^ALLOW_USERS=\"\"/ALLOW_USERS=\"$USER\"/" $CONF
sudo sed -i 's/^TIMELINE_LIMIT_HOURLY=".*"/TIMELINE_LIMIT_HOURLY="5"/' $CONF
sudo sed -i 's/^TIMELINE_LIMIT_DAILY=".*"/TIMELINE_LIMIT_DAILY="5"/' $CONF
sudo sed -i 's/^TIMELINE_LIMIT_WEEKLY=".*"/TIMELINE_LIMIT_WEEKLY="0"/' $CONF
sudo sed -i 's/^TIMELINE_LIMIT_MONTHLY=".*"/TIMELINE_LIMIT_MONTHLY="0"/' $CONF
sudo sed -i 's/^TIMELINE_LIMIT_YEARLY=".*"/TIMELINE_LIMIT_YEARLY="0"/' $CONF
sudo sed -i 's/^NUMBER_LIMIT=".*"/NUMBER_LIMIT="10"/' $CONF

# 3. Enable snap-pac (Automatic snapshots on pacman update)
# archinstall handles the package, we just verify the hook exists
if [ -d "/usr/share/libalpm/hooks" ]; then
    echo "   snap-pac hooks verified."
fi

# 4. Install Limine Snapper Sync (The "Omarchy" Magic)
# This AUR package updates the Limine boot menu when snapshots are created
echo ">> [Chezmoi] Setting up Limine-Snapper-Sync..."

if ! command -v limine-snapper-sync &> /dev/null; then
    echo "   Installing limine-snapper-sync from AUR..."
    
    # Create temp build dir
    BUILD_DIR=$(mktemp -d)
    
    # Clone and build
    git clone https://aur.archlinux.org/limine-snapper-sync.git "$BUILD_DIR"
    
    # We need to run makepkg as the non-root user
    # Note: Ensure the user has sudo rights without password or be ready to type it
    chown -R "$USER" "$BUILD_DIR"
    
    cd "$BUILD_DIR"
    # Switch to user to build, then install with sudo
    sudo -u "$USER" makepkg -si --noconfirm
    
    cd ~
    rm -rf "$BUILD_DIR"
else
    echo "   limine-snapper-sync already installed."
fi

# 5. Initial Sync
echo ">> [Chezmoi] Performing initial snapshot sync..."
# Make sure the service is enabled (it usually installs a systemd watcher or pacman hook)
# limine-snapper-sync usually relies on a pacman hook, but we can force a run now.
sudo limine-snapper-sync

echo ">> [Chezmoi] Setup complete."